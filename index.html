<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Blueprint OCR Upload + Chat</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.3/dist/tesseract.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 2em; }
    #log { white-space: pre-wrap; border: 1px solid #ccc; padding: 1em; margin-top: 1em; background: #f8f8f8; }
    #chatTrigger { margin-top: 2em; display: none; }
  </style>
</head>
<body>
  <h2>Upload a Blueprint PDF (OCR Extract + Agent)</h2>
  <input type="file" id="fileInput" accept="application/pdf" />
  <button onclick="processPDF()">Upload & Extract</button>
  <div id="log"></div>
  <button id="chatTrigger" onclick="sendToChatbot()">Send Extracted Text to Agent Chat</button>

  <script>
    let extractedText = '';

    async function processPDF() {
      const file = document.getElementById('fileInput').files[0];
      if (!file) return alert('Please upload a PDF file.');

      const log = document.getElementById('log');
      log.innerText = 'Processing...';
      const reader = new FileReader();
      reader.readAsArrayBuffer(file);
      reader.onload = async () => {
        try {
          const pdf = await pdfjsLib.getDocument({ data: reader.result }).promise;
          extractedText = '';

          for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const viewport = page.getViewport({ scale: 2.0 });
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            await page.render({ canvasContext: context, viewport }).promise;

            log.innerText = `Running OCR on page ${i}...`;
            const blob = await new Promise(res => canvas.toBlob(res));
            const { data: { text } } = await Tesseract.recognize(blob, 'eng', {
              logger: m => console.log(m)
            });
            extractedText += `\n--- Page ${i} ---\n` + text;
          }

          log.innerText = 'OCR Complete. You may now send it to the chatbot.';
          document.getElementById('chatTrigger').style.display = 'inline-block';

        } catch (err) {
          console.error(err);
          log.innerText = '‚ùå Error: ' + err.message;
        }
      };
    }

    function sendToChatbot() {
      const chatWidget = window.DO_CHATBOT_WIDGET;
      if (chatWidget && typeof chatWidget.sendMessage === 'function') {
        chatWidget.sendMessage(`Here is the blueprint text. Provide a construction cost and risk estimate:\n${extractedText}`);
      } else {
        alert('Chatbot widget not ready. Please refresh the page.');
      }
    }
  </script>

  <!-- DigitalOcean Agent Chatbot Embed -->
  <script async
    src="https://aqa6hys563q26rtqm6cnz6cr.agents.do-ai.run/static/chatbot/widget.js"
    data-agent-id="2e5f98d9-5abd-11f0-bf8f-4e013e2ddde4"
    data-chatbot-id="Vx_4krj2n7uEEBkeudlVzg425uf4lvzO"
    data-name="EstimatorAgent Chatbot"
    data-primary-color="#031B4E"
    data-secondary-color="#E5E8ED"
    data-button-background-color="#0061EB"
    data-starting-message="Hello! How can I help you today?"
    data-logo="/static/chatbot/icons/default-agent.svg">
  </script>
</body>
</html>
