<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Blueprint OCR Upload</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.3/dist/tesseract.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 2em; }
    #log { white-space: pre-wrap; border: 1px solid #ccc; padding: 1em; margin-top: 1em; background: #f8f8f8; }
  </style>
</head>
<body>
  <h2>Upload a Blueprint PDF (OCR Extract + Agent)</h2>
  <input type="file" id="fileInput" accept="application/pdf" />
  <button onclick="processPDF()">Upload & Extract</button>
  <div id="log"></div>

  <script>
    async function processPDF() {
      const file = document.getElementById('fileInput').files[0];
      if (!file) return alert('Please upload a PDF file.');

      const log = document.getElementById('log');
      log.innerText = 'Processing...';
      const reader = new FileReader();
      reader.readAsArrayBuffer(file);
      reader.onload = async () => {
        try {
          const pdf = await pdfjsLib.getDocument({ data: reader.result }).promise;
          let fullText = '';

          for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const viewport = page.getViewport({ scale: 2.0 });
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            await page.render({ canvasContext: context, viewport }).promise;

            log.innerText = `Running OCR on page ${i}...`;
            const blob = await new Promise(res => canvas.toBlob(res));
            const { data: { text } } = await Tesseract.recognize(blob, 'eng', {
              logger: m => console.log(m)
            });
            fullText += `\n--- Page ${i} ---\n` + text;
          }

          log.innerText = 'OCR Complete. Sending to Agent...';

          // Send to agent API
          const agentResponse = await fetch('https://aqa6hys563q26rtqm6cnz6cr.agents.do-ai.run/api/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
              // Include Authorization header if your agent requires it
            },
            body: JSON.stringify({
              messages: [
                { role: 'user', content: `Here is the blueprint text. Provide a construction cost and risk estimate:\n${fullText}` }
              ]
            })
          });

          const responseData = await agentResponse.json();
          const reply = responseData.choices?.[0]?.message?.content || '[No response received]';
          log.innerText = '✅ Agent Response:\n\n' + reply;
        } catch (err) {
          console.error(err);
          log.innerText = '❌ Error: ' + err.message;
        }
      };
    }
  </script>
</body>
</html>
